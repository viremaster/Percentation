<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>API user</title>
</head>

<body>
    <template id="createUserTemplate">
        <h1>Create User</h1>
        <form id="createUserForm">
            <input required type="text" name="name" id="createName" placeholder="Enter your name">
            <input required type="email" name="email" id="createEmail" placeholder="Enter your email">
            <input required type="password" name="password" id="createPassword" placeholder="Enter your password">
            <input required type="submit" value="Create">
        </form>

        <button id="goToLoginUserButton">Already a user ?</button>
    </template>

    <template id="loginUserTemplate">
        <h1>Login User</h1>
        <form id="loginUserForm">
            <input required type="email" name="email" id="loginEmail" placeholder="Enter your email">
            <input required type="password" name="password" id="loginPassword" placeholder="Enter your password">
            <input required type="submit" value="Login">
        </form>
        <button id="goToCreateUserButton">register</button>
    </template>

    <template id="welcomeTemplate">
        <h1>Delete User</h1>
        <form id="DeleteUserForm">
            <input required type="email" name="email" id="deleteEmail" placeholder="Enter your email">
            <input required type="password" name="password" id="deletePassword" placeholder="Enter your password">
            <input type="submit" value="Delete">
        </form>
        <button id="disconnectButton">Disconnect</button>
    </template>
    <div id="content">
    </div>
    <script>
        let authenticatedUser = localStorage.getItem("authenticatedUser");

        let createUserTemplate = get("createUserTemplate"),
            welcomeTemplate = get("welcomeTemplate");

        (function () {
            if (authenticatedUser === 'undefined' || authenticatedUser === null) {
                //Display the login template
                displayLoginForm();
            } else {
                //Display the welcome template
                displayWelcomeTemplate();
            }
        })()


        function displayLoginForm() {
            let loginElement = createElementFromTemplate("loginUserTemplate");
            addElement(loginElement);

            let goToCreateUserButton = get("goToCreateUserButton");
            goToCreateUserButton.onclick = function () {
                clearScreen();
                displayCreateUserForm();
            }
            let loginUserForm = get("loginUserForm");
            loginUserForm.onsubmit = function (e) {
                e.preventDefault();
                let loginEmail = get("loginEmail").value,
                    loginPassword = get("loginPassword").value;
                fetch(`app/user`, {
                    method: "GET",
                    headers: new Headers({
                        'Authorization': 'Basic ' + btoa(loginEmail + ':' + loginPassword),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    })
                }).then(data => {
                    if (data.status === 200) {
                        return data.json();
                    } else {
                        alert("This account does no exists")
                        return new PromiseRejectionEvent();
                    }
                }).then(json => {
                    authenticatedUser = json;
                    localStorage.setItem("authenticatedUser", authenticatedUser.username);
                    clearScreen();
                    displayWelcomeTemplate();
                })
            }
        }

        function displayCreateUserForm() {
            let createUserElement = createElementFromTemplate("createUserTemplate");
            addElement(createUserElement);

            let goToLoginUserButton = get("goToLoginUserButton");

            goToLoginUserButton.onclick = function () {
                clearScreen();
                displayLoginForm();
            }

            let createUserForm = get("createUserForm");
            createUserForm.onsubmit = function (e) {
                e.preventDefault();
                let createEmail = document.getElementById('createEmail'),
                    createName = document.getElementById('createName'),
                    createPassword = document.getElementById('createPassword');
                fetch('/app/user', {
                    method: 'POST',
                    headers: {
                        'accept': '*/*',
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: createName.value,
                        password: createPassword.value,
                        email: createEmail.value
                    })
                }).then(function (res) {
                    console.log(res);
                    if (res.status == 200) {
                        clearScreen();
                        displayLoginForm();
                        return data.json();
                    } else {
                        alert("This email or username already exists")
                        return new PromiseRejectionEvent();
                    }
                }).then(function (data) {
                    console.log(data);
                })
            }
        }

        function displayWelcomeTemplate() {
            let welcomeElement = createElementFromTemplate("welcomeTemplate");

            let welcome = document.createElement("p");
            welcome.innerHTML = "Welcome : " + localStorage.getItem("authenticatedUser");

            addElement(welcome);
            addElement(welcomeElement);

            let DeleteUserForm = get("DeleteUserForm");
            let disconnectButton=get("disconnectButton");

            disconnectButton.onclick=function () {
                localStorage.removeItem("authenticatedUser");
                clearScreen();
                displayLoginForm();

            }

            DeleteUserForm.onsubmit = function (e) {
                e.preventDefault();
                let deleteEmail = document.getElementById("deleteEmail").value,
                    deletePassword = document.getElementById("deletePassword").value;

                fetch("app/user", {
                    method: "DELETE",
                    headers: new Headers({
                        'Authorization': 'Basic ' + btoa(deleteEmail + ':' + deletePassword),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    })
                }).then(data => {
                    if (data.status === 200) {
                        localStorage.removeItem("authenticatedUser");
                        clearScreen()
                        displayLoginForm()
                        return data.json();
                    } else {
                        alert("wrong email or password")
                        return new PromiseRejectionEvent();
                    }
                }).then(json => {
                    console.log(json);
                })
            }
        }

        function createElementFromTemplate(templateID) {
            let template = document.querySelector(templateID);
            let clone = document.importNode(template.content, true);
            return clone;
        }

        function get(id) {
            return document.getElementById(id);
        }

        function createElementFromTemplate(templateID) {
            let template = get(templateID);
            let clone = document.importNode(template.content, true);
            return clone;
        }

        function addElement(element) {
            let content = get("content");
            if (content) {
                if (element) {
                    content.appendChild(element);
                } else {
                    console.error(new Error(`The element is empty`))
                }
            } else {
                console.error(new Error(`There is no content element in the document`))
            }
        }

        function clearScreen() {
            get("content").innerHTML = "";
        }

    </script>

</body>

</html>