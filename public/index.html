<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>API user</title>
</head>

<body>
    <template id="createUserTemplate">
        <h1>Create User</h1>
        <form id="createUserForm">
            <input required type="text" name="name" id="createName" placeholder="Enter your name">
            <input required type="email" name="email" id="createEmail" placeholder="Enter your email">
            <input required type="password" name="password" id="createPassword" placeholder="Enter your password">
            <input required type="submit" value="Create">
        </form>

        <button id="goToLoginUserButton">Already a user ?</button>
    </template>

    <template id="loginUserTemplate">
        <h1>Login User</h1>
        <form id="loginUserForm">
            <input required type="email" name="email" id="loginEmail" placeholder="Enter your email">
            <input required type="password" name="password" id="loginPassword" placeholder="Enter your password">
            <input required type="submit" value="Login">
        </form>
        <button id="goToCreateUserButton">Create an account</button>
    </template>

    <template id="welcomeTemplate">
        <button id="btnDeleteAccount">Delete my account</button>
        <button id="disconnectButton">Disconnect</button>
        <form id="updateUserForm">
            <label>
                Old Password :
                <input required id="oldPasswordInput" type="password">
            </label>
            <label>
                New Password :
                <input required id="newPasswordInput" type="password">
            </label>
            <input type="submit" value="Change password">
        </form>
        <div id="presentationsMiniatures"></div>
        <button id="newPresentationButton">New Presentation</button>

    </template>

    <div id="content">
    </div>
    <script>
        let authenticatedUser = localStorage.getItem("authenticatedUser");
        let token = localStorage.getItem("token")

        let createUserTemplate = get("createUserTemplate"),
            welcomeTemplate = get("welcomeTemplate");

        (function () {
            if (token === 'undefined' || token === null) {
                //Display the login template
                displayLoginForm();
            } else {
                //Display the welcome template
                displayWelcomeTemplate();
            }
        })()

        function displayLoginForm() {
            let loginElement = createElementFromTemplate("loginUserTemplate");
            addElement(loginElement);

            let goToCreateUserButton = get("goToCreateUserButton");
            goToCreateUserButton.onclick = function () {
                clearScreen();
                displayCreateUserForm();
            }
            let loginUserForm = get("loginUserForm");
            loginUserForm.onsubmit = function (e) {
                e.preventDefault();
                let loginEmail = get("loginEmail").value,
                    loginPassword = get("loginPassword").value;
                fetch(`/app/user`, {
                    method: "GET",
                    headers: new Headers({
                        'Authorization': 'Basic ' + btoa(loginEmail + ':' + loginPassword),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    })
                }).then(data => {
                    if (data.status === 200) {
                        console.log(data);
                        return data.json();
                    } else {
                        alert("Wrong email or password")
                    }
                }).then(json => {
                    if (json) {
                        authenticatedUser = json.authenticatedUser;
                        token = json.token;
                        console.log(token);
                        localStorage.setItem("token", token);
                        localStorage.setItem("authenticatedUser", authenticatedUser.username);
                        clearScreen();
                        displayWelcomeTemplate();
                    }
                })
            }
        }

        function displayCreateUserForm() {
            let createUserElement = createElementFromTemplate("createUserTemplate");
            addElement(createUserElement);

            let goToLoginUserButton = get("goToLoginUserButton");

            goToLoginUserButton.onclick = function () {
                clearScreen();
                displayLoginForm();
            }

            let createUserForm = get("createUserForm");
            createUserForm.onsubmit = function (e) {
                e.preventDefault();
                let createEmail = document.getElementById('createEmail'),
                    createName = document.getElementById('createName'),
                    createPassword = document.getElementById('createPassword');
                fetch('/app/user', {
                    method: 'POST',
                    headers: {
                        'accept': '*/*',
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: createName.value,
                        password: createPassword.value,
                        email: createEmail.value
                    })
                }).then(function (res) {
                    console.log(res);
                    if (res.status == 200) {
                        clearScreen();
                        displayLoginForm();
                        return res.json();
                    } else {
                        alert("This email or username already exists")
                        return new PromiseRejectionEvent();
                    }
                }).then(function (data) {
                    console.log(data);
                })
            }
        }

        function displayWelcomeTemplate() {
            let welcomeElement = createElementFromTemplate("welcomeTemplate");

            let welcome = document.createElement("p");
            welcome.innerHTML = "Welcome : " + localStorage.getItem("authenticatedUser");

            addElement(welcome);
            addElement(welcomeElement);

            let btnDeleteAccount = get("btnDeleteAccount");
            let disconnectButton = get("disconnectButton");
            let updateUserForm = get("updateUserForm");
            let newPresentationButton = get("newPresentationButton");

            (function () {
                fetch("app/presentations", {
                    method: "GET",
                    headers: new Headers({
                        'x-access-token': btoa(localStorage.getItem("token"))
                    })
                }).then(data => {
                    if (data.status == 200) {
                        return data;
                    }
                }).then(data => {
                    if (data) {
                        console.log(data);
                        return data.json();
                    }
                }).then(data => {
                    displayPresentations(data)
                })
            })()

            function displayPresentations(data) {
                let presentationsMiniatures = get("presentationsMiniatures");
                for (presentation in data) {
                    let presentationDiv = document.createElement("button");

                    presentationDiv.id = data[presentation].presentationid;
                    let numberPresentation = presentation * 1 + 1;

                    presentationDiv.innerHTML = "Presentation " + numberPresentation;
                    presentationsMiniatures.appendChild(presentationDiv);
                    presentationDiv.addEventListener("click", function () {
                        fetch("/app/presentation/" + this.id, {
                            method: "GET",
                            headers: new Headers({
                                'x-access-token': btoa(localStorage.getItem("token"))
                            })
                        }).then(data => {
                            if (data.status === 200) {
                                return data.json();
                            } else {
                                alert("an error occured");
                            }
                        }).then(json => {
                            if (json) {
                                localStorage.setItem("presentation", json.data);
                                //fetch("/application");
                                window.location.href = "/application";
                            }
                        })
                    })
                }
            }

            updateUserForm.onsubmit = function (e) {
                e.preventDefault();
                fetch("/app/user", {
                    method: 'PUT',
                    headers: new Headers({
                        'x-access-token': btoa(localStorage.getItem("token")),
                        'Authorization': 'Basic ' + btoa(get("oldPasswordInput").value + ':' + get(
                            "newPasswordInput").value),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    })
                }).then(data => {
                    if (data.status == 200) {
                        alert("Your password has been changed !");
                        return data.json();
                    } else {
                        alert("Wrong old password");
                        return new PromiseRejectionEvent();
                    }
                }).then(json => {
                    console.log(json);
                })
            }

            newPresentationButton.addEventListener("click", function () {
                localStorage.removeItem("presentation");
                window.location.href = "/application";
            })

            disconnectButton.onclick = function () {
                localStorage.removeItem("authenticatedUser");
                localStorage.removeItem("token");
                clearScreen();
                displayLoginForm();
            }

            btnDeleteAccount.onclick = function (e) {
                fetch("/app/user", {
                    method: "DELETE",
                    headers: new Headers({
                        'x-access-token': btoa(localStorage.getItem("token")),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    })
                }).then(data => {
                    if (data.status === 200) {
                        localStorage.removeItem("authenticatedUser");
                        localStorage.removeItem("token");
                        clearScreen()
                        displayLoginForm()
                        return data.json();
                    } else {
                        alert("wrong email or password")
                        return new PromiseRejectionEvent();
                    }
                }).then(json => {
                    console.log(json);
                })
            }
        }

        function createElementFromTemplate(templateID) {
            let template = document.querySelector(templateID);
            let clone = document.importNode(template.content, true);
            return clone;
        }

        function get(id) {
            return document.getElementById(id);
        }

        function createElementFromTemplate(templateID) {
            let template = get(templateID);
            let clone = document.importNode(template.content, true);
            return clone;
        }

        function addElement(element) {
            let content = get("content");
            if (content) {
                if (element) {
                    content.appendChild(element);
                } else {
                    console.error(new Error(`The element is empty`))
                }
            } else {
                console.error(new Error(`There is no content element in the document`))
            }
        }

        function clearScreen() {
            get("content").innerHTML = "";
        }
    </script>

</body>

</html>